local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LP = Players.LocalPlayer

local PoliceESP = {
    Enabled = true,
    TeamName = "Police",

    Color = Color3.fromRGB(0,170,255),
    OutlineColor = Color3.fromRGB(255,255,255),

    FillTransparency = 0.25,
    OutlineTransparency = 0,

    ShowName = true,
    ShowDistance = true,

    MaxDistance = 9999,

    Cache = {}
}

local function isPolice(plr)
    return plr
        and plr ~= LP
        and plr.Team
        and plr.Team.Name == PoliceESP.TeamName
end

local function getHRP(char)
    return char and char:FindFirstChild("HumanoidRootPart")
end

local function clear(plr)
    local data = PoliceESP.Cache[plr]
    if not data then return end

    if data.Highlight then pcall(function() data.Highlight:Destroy() end) end
    if data.Billboard then pcall(function() data.Billboard:Destroy() end) end

    PoliceESP.Cache[plr] = nil
end

local function createESP(plr)
    if not PoliceESP.Enabled then return end
    if not isPolice(plr) then return end
    if not plr.Character then return end

    local hrp = getHRP(plr.Character)
    if not hrp then return end

    clear(plr)

    local hl = Instance.new("Highlight")
    hl.Name = "PoliceESP"
    hl.Adornee = plr.Character
    hl.FillColor = PoliceESP.Color
    hl.OutlineColor = PoliceESP.OutlineColor
    hl.FillTransparency = PoliceESP.FillTransparency
    hl.OutlineTransparency = PoliceESP.OutlineTransparency
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = plr.Character

    local bb = Instance.new("BillboardGui")
    bb.Size = UDim2.new(0,200,0,50)
    bb.StudsOffset = Vector3.new(0,3,0)
    bb.AlwaysOnTop = true
    bb.Adornee = hrp
    bb.Parent = hrp

    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.new(1,0,1,0)
    txt.BackgroundTransparency = 1
    txt.TextColor3 = PoliceESP.Color
    txt.TextStrokeTransparency = 0
    txt.Font = Enum.Font.GothamBold
    txt.TextSize = 14
    txt.Text = "" -- khởi tạo rỗng để check update
    txt.Parent = bb

    PoliceESP.Cache[plr] = {
        Highlight = hl,
        Billboard = bb,
        Text = txt,
        LastText = ""
    }

    plr.CharacterRemoving:Once(function()
        clear(plr)
    end)
end

-- update ESP nhưng chỉ khi thay đổi text hoặc khoảng cách vượt MaxDistance
RunService.Heartbeat:Connect(function()
    if not PoliceESP.Enabled then return end
    if not next(PoliceESP.Cache) then return end

    local camPos = Camera.CFrame.Position

    for plr,data in pairs(PoliceESP.Cache) do
        if not plr or not plr.Character or not isPolice(plr) then
            clear(plr)
            continue
        end

        local hrp = getHRP(plr.Character)
        if not hrp or not data.Billboard or not data.Text then
            clear(plr)
            continue
        end

        local dist = (camPos - hrp.Position).Magnitude
        local enable = dist <= PoliceESP.MaxDistance
        data.Billboard.Enabled = enable
        if not enable then continue end

        local text = ""
        if PoliceESP.ShowName then
            text = plr.Name
        end
        if PoliceESP.ShowDistance then
            text ..= string.format(" [%dm]", math.floor(dist))
        end

        if text ~= data.LastText then -- chỉ update khi text thay đổi
            data.Text.Text = text
            data.LastText = text
        end
    end
end)

local function hook(plr)
    plr.CharacterAdded:Connect(function()
        task.wait(0.2)
        createESP(plr)
    end)

    plr:GetPropertyChangedSignal("Team"):Connect(function()
        task.wait(0.1)
        if isPolice(plr) then
            createESP(plr)
        else
            clear(plr)
        end
    end)
end

for _,plr in ipairs(Players:GetPlayers()) do
    hook(plr)
    createESP(plr)
end

Players.PlayerAdded:Connect(function(plr)
    hook(plr)
end)

Players.PlayerRemoving:Connect(function(plr)
    clear(plr)
end)

function PoliceESP:Enable()
    self.Enabled = true
    for _,plr in ipairs(Players:GetPlayers()) do
        createESP(plr)
    end
end

function PoliceESP:Disable()
    self.Enabled = false
    for plr,_ in pairs(self.Cache) do
        clear(plr)
    end
end
