local Players=game:GetService("Players")
local RunService=game:GetService("RunService")
local Camera=workspace.CurrentCamera
local LP=Players.LocalPlayer

local drawings={}

local function valid(p)
	if p==LP then return end
	if not p.Team or p.Team.Name~="Police" then return end
	local c=p.Character
	if not c then return end
	local h=c:FindFirstChildOfClass("Humanoid")
	local r=c:FindFirstChild("HumanoidRootPart")
	if not h or not r or h.Health<=0 then return end
	return h,r
end

local function make()
	local bg=Drawing.new("Square")
	bg.Filled=true
	bg.Thickness=0
	bg.Color=Color3.fromRGB(25,25,25)
	bg.Transparency=0.8
	bg.Visible=false

	local fg=Drawing.new("Square")
	fg.Filled=true
	fg.Thickness=0
	fg.Transparency=0.9
	fg.Visible=false

	return bg,fg
end

local function clear(p)
	local d=drawings[p]
	if not d then return end
	d[1]:Remove()
	d[2]:Remove()
	drawings[p]=nil
end

Players.PlayerRemoving:Connect(clear)

RunService.RenderStepped:Connect(function()
	for _,p in ipairs(Players:GetPlayers()) do
		local h,r=valid(p)
		if h then
			local pos,on=Camera:WorldToViewportPoint(r.Position)
			if on then
				local d=drawings[p]
				if not d then
					local bg,fg=make()
					d={bg,fg}
					drawings[p]=d
				end

				local hp=h.Health/h.MaxHealth
				local height=math.clamp(12000/pos.Z,20,42)
				local width=3
				local x=pos.X-16
				local y=pos.Y-height/2

				d[1].Size=Vector2.new(width,height)
				d[1].Position=Vector2.new(x,y)
				d[1].Visible=true

				d[2].Size=Vector2.new(width,height*hp)
				d[2].Position=Vector2.new(x,y+height*(1-hp))
				d[2].Color=Color3.fromRGB(255*(1-hp),255*hp,60)
				d[2].Visible=true
			else
				clear(p)
			end
		else
			clear(p)
		end
	end
end)
